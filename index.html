<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>‚ùÑÔ∏è ICECOAST - East Coast Ski Conditions</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, Cantarell, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #333;
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
            }

            header {
                text-align: center;
                margin-bottom: 30px;
                color: white;
            }

            h1 {
                font-size: 3em;
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }

            .subtitle {
                font-size: 1.2em;
                opacity: 0.9;
            }

            .last-updated {
                margin-top: 10px;
                font-size: 0.9em;
                opacity: 0.8;
            }

            .controls {
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-bottom: 30px;
            }

            .filter-group {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                margin-bottom: 15px;
            }

            .filter-section {
                flex: 1;
                min-width: 200px;
            }

            .filter-section label {
                display: block;
                font-weight: 600;
                margin-bottom: 8px;
                color: #555;
            }

            select,
            input {
                width: 100%;
                padding: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            select:focus,
            input:focus {
                outline: none;
                border-color: #667eea;
            }

            .resort-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 20px;
            }

            .resort-card {
                background: white;
                border-radius: 15px;
                overflow: hidden;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition:
                    transform 0.3s,
                    box-shadow 0.3s;
                cursor: pointer;
            }

            .resort-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
            }

            .resort-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                position: relative;
            }

            .resort-icon {
                font-size: 2.5em;
                margin-bottom: 5px;
            }

            .resort-name {
                font-size: 1.4em;
                font-weight: bold;
                margin-bottom: 5px;
            }

            .resort-location {
                font-size: 0.9em;
                opacity: 0.9;
            }

            .resort-body {
                padding: 20px;
            }

            .weather-section {
                margin-bottom: 15px;
            }

            .current-weather {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px;
            }

            .temp-display {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .temp-large {
                font-size: 2.5em;
                font-weight: bold;
                color: #667eea;
            }

            .weather-icon {
                font-size: 2em;
            }

            .weather-details {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                font-size: 0.9em;
                color: #666;
                margin-top: 10px;
            }

            .forecast {
                display: flex;
                justify-content: space-between;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #e0e0e0;
            }

            .forecast-day {
                text-align: center;
                flex: 1;
            }

            .forecast-day-name {
                font-size: 0.85em;
                color: #666;
                margin-bottom: 5px;
            }

            .forecast-icon {
                font-size: 1.5em;
                margin: 5px 0;
            }

            .forecast-temp {
                font-size: 0.9em;
                color: #333;
            }

            .forecast-snow {
                font-size: 0.8em;
                color: #667eea;
                font-weight: 600;
                margin-top: 3px;
            }

            .lifts-section {
                margin-top: 15px;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 8px;
            }

            .lifts-header {
                font-weight: 600;
                margin-bottom: 8px;
                color: #555;
            }

            .lifts-status {
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 1.1em;
            }

            .lifts-open {
                color: #28a745;
                font-weight: bold;
            }

            .lifts-total {
                color: #666;
            }

            .rating {
                position: absolute;
                top: 15px;
                right: 15px;
                background: rgba(255, 255, 255, 0.95);
                color: #667eea;
                padding: 8px 12px;
                border-radius: 20px;
                font-weight: bold;
                font-size: 1.1em;
            }

            .no-data {
                color: #999;
                font-style: italic;
                text-align: center;
                padding: 10px;
            }

            .loading {
                text-align: center;
                color: white;
                font-size: 1.5em;
                padding: 40px;
            }

            .error {
                background: #f8d7da;
                color: #721c24;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                text-align: center;
            }

            @media (max-width: 768px) {
                h1 {
                    font-size: 2em;
                }

                .filter-group {
                    flex-direction: column;
                }

                .resort-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>‚ùÑÔ∏è ICECOAST</h1>
                <div class="subtitle">Live East Coast Ski Conditions</div>
                <div class="last-updated" id="lastUpdated">Loading...</div>
            </header>

            <div class="controls">
                <div class="filter-group">
                    <div class="filter-section">
                        <label for="regionFilter">Region</label>
                        <select id="regionFilter">
                            <option value="all">All Regions</option>
                            <option value="poconos">Poconos</option>
                            <option value="catskills">Catskills</option>
                            <option value="adirondacks">Adirondacks</option>
                            <option value="massachusetts">Massachusetts</option>
                            <option value="connecticut">Connecticut</option>
                            <option value="vermont-south">
                                Southern Vermont
                            </option>
                            <option value="vermont-central">
                                Central Vermont
                            </option>
                            <option value="vermont-north">
                                Northern Vermont
                            </option>
                            <option value="white-mountains">
                                White Mountains
                            </option>
                            <option value="maine">Maine</option>
                            <option value="canada">Canada</option>
                        </select>
                    </div>

                    <div class="filter-section">
                        <label for="sortFilter">Sort By</label>
                        <select id="sortFilter">
                            <option value="rating">
                                Rating (Best Conditions)
                            </option>
                            <option value="temp-low">
                                Temperature (Coldest)
                            </option>
                            <option value="temp-high">
                                Temperature (Warmest)
                            </option>
                            <option value="snow">Forecasted Snow</option>
                            <option value="name">Name (A-Z)</option>
                        </select>
                    </div>

                    <div class="filter-section">
                        <label for="searchFilter">Search</label>
                        <input
                            type="text"
                            id="searchFilter"
                            placeholder="Search resorts..."
                        />
                    </div>
                </div>
            </div>

            <div id="errorMessage"></div>
            <div id="resortGrid" class="resort-grid">
                <div class="loading">Loading resort data...</div>
            </div>
        </div>

        <!-- Load resorts.js first -->
        <script src="resorts.js"></script>

        <script>
            // Configuration
            const API_URL =
                "https://cloudflare-worker.rickt123-0f8.workers.dev"; // Update with your Cloudflare Worker URL
            const REFRESH_INTERVAL = 15 * 60 * 1000; // 15 minutes

            let resortsData = [];
            let filteredResorts = [];

            // Initialize from resorts.js
            function initializeResorts() {
                if (typeof RESORTS === "undefined") {
                    console.error("resorts.js not loaded properly");
                    showError("Failed to load resort configuration");
                    return;
                }

                // Convert RESORTS array to working format
                resortsData = RESORTS.map((resort) => ({
                    id: resort.id,
                    name: resort.name,
                    icon: resort.icon,
                    location: resort.location,
                    region: resort.region,
                    familyOwned: resort.familyOwned,
                    lat: resort.lat,
                    lon: resort.lon,
                    liftie: resort.liftie,
                    // Will be populated from API
                    weather: null,
                    forecast: null,
                    lifts: null,
                    rating: 0,
                }));

                console.log(
                    `Initialized ${resortsData.length} resorts from resorts.js`,
                );
            }

            // Fetch live data from Cloudflare Worker
            async function fetchResortData() {
                try {
                    const response = await fetch(API_URL);

                    if (!response.ok) {
                        throw new Error(
                            `HTTP ${response.status}: ${response.statusText}`,
                        );
                    }

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    return data;
                } catch (error) {
                    console.error("Failed to fetch resort data:", error);
                    showError(`Unable to load live data: ${error.message}`);
                    return null;
                }
            }

            // Merge API data with base resort data
            function mergeResortData(apiData) {
                resortsData.forEach((resort) => {
                    const liveData = apiData[resort.id];

                    if (liveData) {
                        resort.weather = liveData.weather || null;
                        resort.forecast = liveData.forecast || null;
                        resort.lifts = liveData.lifts || null;
                        resort.rating = calculateRating(resort);
                    }
                });

                // Update last updated time
                if (apiData._metadata) {
                    updateLastUpdatedTime(apiData._metadata.lastUpdated);
                }
            }

            // Calculate rating based on conditions
            function calculateRating(resort) {
                let rating = 50; // Base rating

                if (!resort.weather) return rating;

                // Temperature scoring (prefer 15-30¬∞F)
                const temp = resort.weather.temp;
                if (temp >= 15 && temp <= 30) {
                    rating += 20;
                } else if (temp >= 10 && temp <= 35) {
                    rating += 10;
                } else if (temp < 10 || temp > 40) {
                    rating -= 10;
                }

                // Snow forecast scoring
                if (resort.forecast && resort.forecast.length > 0) {
                    const totalSnow = resort.forecast.reduce(
                        (sum, day) => sum + (day.snow || 0),
                        0,
                    );
                    rating += Math.min(totalSnow * 5, 30);
                }

                // Lifts open scoring
                if (resort.lifts) {
                    const openPercent =
                        (resort.lifts.open / resort.lifts.total) * 100;
                    if (openPercent >= 80) rating += 15;
                    else if (openPercent >= 50) rating += 10;
                    else if (openPercent < 30) rating -= 10;
                }

                // Weather condition scoring
                if (resort.weather.icon === "‚ùÑÔ∏è") rating += 15;
                else if (resort.weather.icon === "üåßÔ∏è") rating -= 15;

                return Math.max(0, Math.min(100, Math.round(rating)));
            }

            // Render resort cards
            function renderResorts(resorts) {
                const grid = document.getElementById("resortGrid");

                if (resorts.length === 0) {
                    grid.innerHTML =
                        '<div class="no-data">No resorts match your filters</div>';
                    return;
                }

                grid.innerHTML = resorts
                    .map(
                        (resort) => `
                <div class="resort-card" data-id="${resort.id}">
                    <div class="resort-header">
                        <div class="rating">${resort.rating || "--"}</div>
                        <div class="resort-icon">${resort.icon}</div>
                        <div class="resort-name">${resort.name}</div>
                        <div class="resort-location">${resort.location}</div>
                    </div>
                    <div class="resort-body">
                        ${renderWeather(resort)}
                        ${renderForecast(resort)}
                        ${renderLifts(resort)}
                    </div>
                </div>
            `,
                    )
                    .join("");
            }

            function renderWeather(resort) {
                if (!resort.weather) {
                    return '<div class="no-data">Weather data unavailable</div>';
                }

                const w = resort.weather;
                return `
                <div class="weather-section">
                    <div class="current-weather">
                        <div class="temp-display">
                            <div class="temp-large">${w.temp}¬∞</div>
                            <div class="weather-icon">${w.icon}</div>
                        </div>
                    </div>
                    <div class="weather-details">
                        <div>üí® ${w.wind}</div>
                        <div>üå°Ô∏è Feels ${w.feelsLike}¬∞</div>
                        <div>üíß ${w.humidity}%</div>
                        <div>${w.condition}</div>
                    </div>
                </div>
            `;
            }

            function renderForecast(resort) {
                if (!resort.forecast || resort.forecast.length === 0) {
                    return "";
                }

                const forecastDays = resort.forecast
                    .slice(0, 3)
                    .map(
                        (day) => `
                <div class="forecast-day">
                    <div class="forecast-day-name">${day.day}</div>
                    <div class="forecast-icon">${day.icon}</div>
                    <div class="forecast-temp">${day.temp}¬∞</div>
                    ${day.snow > 0 ? `<div class="forecast-snow">‚ùÑÔ∏è ${day.snow}"</div>` : ""}
                </div>
            `,
                    )
                    .join("");

                return `
                <div class="forecast">
                    ${forecastDays}
                </div>
            `;
            }

            function renderLifts(resort) {
                if (!resort.lifts) {
                    return "";
                }

                return `
                <div class="lifts-section">
                    <div class="lifts-header">Lifts</div>
                    <div class="lifts-status">
                        <span class="lifts-open">${resort.lifts.open} Open</span>
                        <span class="lifts-total">/ ${resort.lifts.total} Total</span>
                    </div>
                </div>
            `;
            }

            // Filter and sort resorts
            function filterAndSortResorts() {
                const region = document.getElementById("regionFilter").value;
                const sort = document.getElementById("sortFilter").value;
                const search = document
                    .getElementById("searchFilter")
                    .value.toLowerCase();

                // Filter
                filteredResorts = resortsData.filter((resort) => {
                    const matchesRegion =
                        region === "all" || resort.region === region;
                    const matchesSearch =
                        search === "" ||
                        resort.name.toLowerCase().includes(search) ||
                        resort.location.toLowerCase().includes(search);

                    return matchesRegion && matchesSearch;
                });

                // Sort
                filteredResorts.sort((a, b) => {
                    switch (sort) {
                        case "rating":
                            return (b.rating || 0) - (a.rating || 0);
                        case "temp-low":
                            return (
                                (a.weather?.temp || 999) -
                                (b.weather?.temp || 999)
                            );
                        case "temp-high":
                            return (
                                (b.weather?.temp || -999) -
                                (a.weather?.temp || -999)
                            );
                        case "snow":
                            const aSnow =
                                a.forecast?.reduce(
                                    (sum, d) => sum + (d.snow || 0),
                                    0,
                                ) || 0;
                            const bSnow =
                                b.forecast?.reduce(
                                    (sum, d) => sum + (d.snow || 0),
                                    0,
                                ) || 0;
                            return bSnow - aSnow;
                        case "name":
                            return a.name.localeCompare(b.name);
                        default:
                            return 0;
                    }
                });

                renderResorts(filteredResorts);
            }

            function updateLastUpdatedTime(timestamp) {
                if (!timestamp) return;

                const date = new Date(timestamp);
                const timeString = date.toLocaleString("en-US", {
                    month: "short",
                    day: "numeric",
                    hour: "numeric",
                    minute: "2-digit",
                    timeZoneName: "short",
                });

                document.getElementById("lastUpdated").textContent =
                    `Last updated: ${timeString}`;
            }

            function showError(message) {
                const errorDiv = document.getElementById("errorMessage");
                errorDiv.innerHTML = `<div class="error">${message}</div>`;
                setTimeout(() => {
                    errorDiv.innerHTML = "";
                }, 5000);
            }

            // Initialize and load data
            async function init() {
                // Load base resort data from resorts.js
                initializeResorts();

                // Fetch live data from API
                const apiData = await fetchResortData();

                if (apiData) {
                    mergeResortData(apiData);
                }

                // Initial render
                filterAndSortResorts();

                // Set up filter listeners
                document
                    .getElementById("regionFilter")
                    .addEventListener("change", filterAndSortResorts);
                document
                    .getElementById("sortFilter")
                    .addEventListener("change", filterAndSortResorts);
                document
                    .getElementById("searchFilter")
                    .addEventListener("input", filterAndSortResorts);

                // Auto-refresh
                setInterval(async () => {
                    const apiData = await fetchResortData();
                    if (apiData) {
                        mergeResortData(apiData);
                        filterAndSortResorts();
                    }
                }, REFRESH_INTERVAL);
            }

            // Start the app
            document.addEventListener("DOMContentLoaded", init);
        </script>
    </body>
</html>
