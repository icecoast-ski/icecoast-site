<!DOCTYPE html>
<html lang="en">
<!--
  ICECOAST - East Coast Ski Conditions

  SETUP
  1. Deploy cloudflare-worker.js to Cloudflare Workers
  2. Set OPENWEATHER_API_KEY env var in the scheduler worker
  3. Bind ICECOAST_DATA KV to both workers
  4. Deploy this file to Cloudflare Pages as index.html
-->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>icecoast - east coast snow, terrain, and resort conditions</title>

  <style>
    :root {
      --primary-blue: #0066FF;
      --ocean-blue: #0052CC;
      --sky-light: #E6F2FF;
      --coral: #FF5A5F;
      --forest: #00A699;
      --charcoal: #222222;
      --medium-grey: #717171;
      --light-grey: #DDDDDD;
      --bg-grey: #F7F7F7;
      --off-white: #FBFBFB;
      --white: #FFFFFF;
      --snow: #FAFAFA;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: var(--bg-grey);
      color: var(--charcoal);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    header {
      background: var(--white);
      padding: 0.75rem 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .header-left {
      display: flex;
      align-items: baseline;
      gap: 0.75rem;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      color: var(--charcoal);
      margin: 0;
    }

    .logo span {
      color: var(--primary-blue);
    }

    .main-tagline {
      font-size: 0.75rem;
      color: #5A5A5A;
      font-weight: 600;
      margin: 0;
    }

    .sub-header {
      background: var(--off-white);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--light-grey);
    }

    .sub-header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: center;
      text-align: center;
    }

    .sub-tagline {
      font-size: 0.85rem;
      color: var(--medium-grey);
      font-weight: 500;
      margin: 0;
      line-height: 1.4;
      max-width: 600px;
    }

    .cta-btn {
      padding: 0.6rem 1.25rem;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(74, 144, 164, 0.3);
      position: relative;
      overflow: visible;
    }

    .cta-btn:hover {
      background: var(--ocean-blue);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(74, 144, 164, 0.4);
    }

    /* Filters */
    .filters {
      max-width: 1400px;
      margin: 0.5rem auto;
      padding: 0 1.5rem;
    }

    .filter-group {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
      background: var(--white);
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .filter-label {
      font-weight: 600;
      color: var(--charcoal);
      font-size: 0.75rem;
      min-width: 60px;
    }

    .filter-btn {
      padding: 0.4rem 0.75rem;
      border: 1.5px solid var(--light-grey);
      background: var(--white);
      border-radius: 20px;
      font-family: inherit;
      font-weight: 600;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--charcoal);
    }

    .filter-btn:hover {
      border-color: var(--charcoal);
      background: var(--snow);
    }

    .filter-btn.active {
      background: var(--charcoal);
      border-color: var(--charcoal);
      color: var(--white);
    }

    .sort-select {
      padding: 0.4rem 0.75rem;
      border: 1.5px solid var(--light-grey);
      background: var(--white);
      border-radius: 6px;
      font-family: inherit;
      font-weight: 600;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--charcoal);
      min-width: 160px;
    }

    .sort-select:hover {
      border-color: var(--charcoal);
    }

    .sort-select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
    }

    /* Resort Grid */
    .resort-grid {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1.5rem 3rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 1.5rem;
    }

    .resort-card {
      background: var(--white);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
    }

    .resort-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .resort-header {
      padding: 1.5rem 1.5rem 1.25rem;
      border-bottom: 1px solid var(--bg-grey);
      margin: 0;
      border-radius: 16px 16px 0 0;
      min-height: 140px;
      overflow: hidden;
      position: relative;
      background-size: 125%;
      background-position: center;
      background-repeat: no-repeat;
    }

    .resort-location {
      color: var(--medium-grey);
      font-size: 0.875rem;
      font-weight: 500;
      text-shadow:
        0 1px 6px rgba(255, 255, 255, 1),
        0 1px 2px rgba(255, 255, 255, 0.9);
    }

    .resort-body {
      padding: 1.5rem;
    }

    /* Rating Section */
    .rating-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--bg-grey);
    }

    .rating-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
      color: var(--medium-grey);
      margin-bottom: 0.4rem;
    }

    .rating-stars {
      display: flex;
      gap: 0.25rem;
    }

    .star {
      font-size: 1.25rem;
      transition: transform 0.2s ease;
    }

    .star.filled {
      color: var(--primary-blue);
    }

    .star.empty {
      color: var(--light-grey);
    }

    .rating-text {
      font-size: 0.95rem;
      font-weight: 800;
      color: var(--charcoal);
      background: var(--white);
      padding: 0.65rem 1.25rem;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border: 3px solid var(--charcoal);
      position: relative;
      white-space: nowrap;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.15);
    }

    .rating-text::before {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 20px;
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid var(--charcoal);
    }

    .rating-text::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 22px;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid var(--white);
    }

    /* Conditions Highlight */
    .conditions-highlight {
      background: linear-gradient(135deg, var(--primary-blue), var(--ocean-blue));
      color: var(--white);
      padding: 1.25rem;
      border-radius: 12px;
      margin-bottom: 1.25rem;
    }

    .conditions-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }

    .conditions-value {
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .info-label {
      font-size: 0.875rem;
      color: var(--medium-grey);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-value {
      font-weight: 600;
      color: var(--charcoal);
      font-size: 0.9rem;
    }

    /* Forecast */
    .forecast-details {
      margin-top: 1rem;
      border: 1px solid var(--light-grey);
      border-radius: 8px;
      overflow: hidden;
    }

    .forecast-toggle {
      padding: 0.65rem 0.85rem;
      background: var(--snow);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--charcoal);
      list-style: none;
      user-select: none;
      transition: background 0.2s ease;
    }

    .forecast-toggle:hover {
      background: var(--bg-grey);
    }

    .forecast-toggle::-webkit-details-marker {
      display: none;
    }

    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      padding: 0.85rem;
      background: var(--white);
    }

    .forecast-day {
      text-align: center;
    }

    .forecast-day-name {
      font-weight: 600;
      font-size: 0.75rem;
      margin-bottom: 0.35rem;
      color: var(--medium-grey);
    }

    .forecast-icon {
      font-size: 1.75rem;
      margin: 0.35rem 0;
    }

    .forecast-temp {
      font-weight: 600;
      color: var(--charcoal);
      font-size: 0.85rem;
    }

    .forecast-snow {
      font-size: 0.75rem;
      color: var(--forest);
      font-weight: 600;
      margin-top: 0.2rem;
    }

    /* Lift Status */
    .lift-details {
      margin-top: 0.75rem;
      border: 1px solid var(--light-grey);
      border-radius: 8px;
      overflow: hidden;
    }

    .lift-toggle {
      padding: 0.65rem 0.85rem;
      background: var(--snow);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--charcoal);
      list-style: none;
      user-select: none;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .lift-toggle:hover {
      background: var(--bg-grey);
    }

    .lift-toggle::-webkit-details-marker {
      display: none;
    }

    .lift-toggle-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .lift-toggle-counts {
      display: flex;
      gap: 0.35rem;
      align-items: center;
    }

    .lift-list {
      padding: 0.5rem 0.85rem 0.75rem;
      background: var(--white);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.25rem 1rem;
      max-height: 280px;
      overflow-y: auto;
    }

    .lift-item {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.3rem 0;
      font-size: 0.75rem;
      line-height: 1.3;
    }

    .lift-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .lift-dot.open {
      background: var(--forest);
      box-shadow: 0 0 4px rgba(0, 166, 153, 0.4);
    }

    .lift-dot.closed {
      background: var(--coral);
    }

    .lift-dot.hold {
      background: #FFB84D;
    }

    .lift-dot.scheduled {
      background: var(--light-grey);
    }

    .lift-name {
      color: var(--charcoal);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .lift-name.closed-lift {
      color: var(--medium-grey);
    }

    /* Status toast */
    .status-toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--charcoal);
      color: white;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 9999;
    }

    .status-toast.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(-4px);
    }

    .status-toast.info {
      background: var(--charcoal);
    }

    .status-toast.success {
      background: var(--forest);
    }

    .status-toast.warning {
      background: var(--coral);
    }

    .loading {
      padding: 2rem;
      text-align: center;
      font-size: 0.9rem;
      color: var(--medium-grey);
    }

    @media (max-width: 900px) {
      .filter-group {
        padding: 0.4rem 0.5rem;
      }
      .filter-label {
        min-width: 50px;
        font-size: 0.7rem;
      }
      .filter-btn,
      .sort-select {
        font-size: 0.7rem;
        padding: 0.35rem 0.6rem;
      }
      .resort-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="header-top">
        <div class="header-left">
          <h1 class="logo">ice<span>coast</span></h1>
          <p class="main-tagline">Know the snow before you go.</p>
        </div>
      </div>
    </div>
  </header>

  <div class="sub-header">
    <div class="sub-header-content">
      <p class="sub-tagline">
        Real-time snow, terrain, and resort conditions‚Äîso you know when it's worth the drive.
      </p>
      <button class="cta-btn" id="checkConditionsBtn">Check Conditions Now</button>
    </div>
  </div>

  <div class="filters">
    <div class="filter-group">
      <span class="filter-label">Region:</span>
      <button class="filter-btn active" data-region="all">All</button>
      <button class="filter-btn" data-region="poconos">Poconos</button>
      <button class="filter-btn" data-region="catskills">Catskills</button>
      <button class="filter-btn" data-region="adirondacks">Adirondacks</button>
      <button class="filter-btn" data-region="southern-vt">Stratton Area</button>
      <button class="filter-btn" data-region="central-vt">Mad River Valley</button>
      <button class="filter-btn" data-region="northern-vt">Jay Peak</button>
      <button class="filter-btn" data-region="white-mountains">White Mtns</button>
      <button class="filter-btn" data-region="maine">Maine</button>

      <span class="filter-label" style="margin-left: 1rem;">Pass:</span>
      <button class="filter-btn active" data-pass="all">All</button>
      <button class="filter-btn" data-pass="ikon">Ikon</button>
      <button class="filter-btn" data-pass="epic">Epic</button>

      <span class="filter-label" style="margin-left: 1rem;">Vibe:</span>
      <button class="filter-btn active" data-vibe="all">All</button>
      <button class="filter-btn" data-vibe="sendit">Send It</button>
      <button class="filter-btn" data-vibe="avoid">Avoid</button>

      <span class="filter-label" style="margin-left: 1rem;">Sort:</span>
      <select class="sort-select" id="sortSelect">
        <option value="rating-high">Best Conditions</option>
        <option value="rating-low">Worst Conditions</option>
        <option value="snow-24h">Most Snow (24h)</option>
        <option value="snow-7d">Most Snow (7d)</option>
        <option value="price-low">Lowest Price</option>
        <option value="price-high">Highest Price</option>
      </select>
    </div>
  </div>

  <div class="resort-grid" id="resortGrid">
    <div class="loading">Loading resort data...</div>
  </div>

  <div id="statusToast" class="status-toast info">
    <span id="statusText">‚õ∑Ô∏è</span>
  </div>

  <script>
    // üîß CONFIG ‚Äì Cloudflare Worker endpoint for live data
    const WORKER_URL = "https://cloudflare-worker.rickt123-0f8.workers.dev/";

    // Map HTML IDs to worker IDs if needed
    const IDMAP = {
      // example: "blue": "blue-mountain"
    };

    function getWorkerID(htmlID) {
      return IDMAP[htmlID] || htmlID;
    }

    // Toast helpers
    const statusToast = document.getElementById('statusToast');
    const statusText = document.getElementById('statusText');

    function showStatus(message, type = 'info', timeout = 4000) {
      if (!statusToast || !statusText) return;
      statusText.textContent = message;
      statusToast.className = 'status-toast ' + type;
      statusToast.classList.add('visible');
      if (timeout) {
        setTimeout(() => statusToast.classList.remove('visible'), timeout);
      }
    }

    // Static resort definitions (minimal example; extend as needed)
    const resorts = [
      { id: 'camelback', name: 'Camelback', region: 'poconos', pass: 'epic', vibe: 'sendit', rating: 3.5, price: 110 },
      { id: 'blue-mountain', name: 'Blue Mountain', region: 'poconos', pass: 'epic', vibe: 'avoid', rating: 3.0, price: 95 },
      { id: 'jack-frost', name: 'Jack Frost', region: 'poconos', pass: 'ikon', vibe: 'sendit', rating: 3.8, price: 85 },
      { id: 'shawnee', name: 'Shawnee', region: 'poconos', pass: 'ikon', vibe: 'avoid', rating: 3.2, price: 80 },
      { id: 'bear-creek', name: 'Bear Creek', region: 'poconos', pass: 'ikon', vibe: 'sendit', rating: 3.6, price: 90 },
      { id: 'elk', name: 'Elk', region: 'poconos', pass: 'ikon', vibe: 'sendit', rating: 4.2, price: 100 },
      { id: 'big-boulder', name: 'Big Boulder', region: 'poconos', pass: 'epic', vibe: 'avoid', rating: 3.1, price: 75 },
      { id: 'montage', name: 'Montage', region: 'poconos', pass: 'ikon', vibe: 'sendit', rating: 3.7, price: 88 },

      { id: 'hunter', name: 'Hunter', region: 'catskills', pass: 'epic', vibe: 'avoid', rating: 3.3, price: 130 },
      { id: 'windham', name: 'Windham', region: 'catskills', pass: 'ikon', vibe: 'sendit', rating: 3.9, price: 125 },
      { id: 'belleayre', name: 'Belleayre', region: 'catskills', pass: 'ikon', vibe: 'sendit', rating: 3.8, price: 105 },

      { id: 'whiteface', name: 'Whiteface', region: 'adirondacks', pass: 'ikon', vibe: 'sendit', rating: 4.1, price: 115 },
      { id: 'gore', name: 'Gore', region: 'adirondacks', pass: 'ikon', vibe: 'sendit', rating: 4.0, price: 110 },
      { id: 'greek-peak', name: 'Greek Peak', region: 'adirondacks', pass: 'ikon', vibe: 'avoid', rating: 3.4, price: 90 },
      { id: 'bristol', name: 'Bristol', region: 'adirondacks', pass: 'ikon', vibe: 'sendit', rating: 3.6, price: 92 },
      { id: 'holiday-valley', name: 'Holiday Valley', region: 'adirondacks', pass: 'ikon', vibe: 'sendit', rating: 4.0, price: 98 },

      { id: 'stratton', name: 'Stratton', region: 'southern-vt', pass: 'ikon', vibe: 'sendit', rating: 4.0, price: 140 },
      { id: 'mount-snow', name: 'Mount Snow', region: 'southern-vt', pass: 'epic', vibe: 'sendit', rating: 3.8, price: 135 },
      { id: 'bromley', name: 'Bromley', region: 'southern-vt', pass: 'ikon', vibe: 'sendit', rating: 3.7, price: 120 },
      { id: 'magic', name: 'Magic', region: 'southern-vt', pass: 'ikon', vibe: 'sendit', rating: 3.9, price: 115 },

      { id: 'killington', name: 'Killington', region: 'central-vt', pass: 'ikon', vibe: 'sendit', rating: 4.3, price: 150 },
      { id: 'pico', name: 'Pico', region: 'central-vt', pass: 'ikon', vibe: 'sendit', rating: 3.8, price: 120 },
      { id: 'okemo', name: 'Okemo', region: 'central-vt', pass: 'epic', vibe: 'sendit', rating: 4.0, price: 145 },
      { id: 'sugarbush', name: 'Sugarbush', region: 'central-vt', pass: 'ikon', vibe: 'sendit', rating: 4.2, price: 145 },
      { id: 'mad-river-glen', name: 'Mad River Glen', region: 'central-vt', pass: 'ikon', vibe: 'sendit', rating: 4.1, price: 120 },
      { id: 'bolton-valley', name: 'Bolton Valley', region: 'central-vt', pass: 'ikon', vibe: 'sendit', rating: 3.9, price: 110 },

      { id: 'stowe', name: 'Stowe', region: 'northern-vt', pass: 'epic', vibe: 'sendit', rating: 4.5, price: 160 },
      { id: 'jay-peak', name: 'Jay Peak', region: 'northern-vt', pass: 'ikon', vibe: 'sendit', rating: 4.6, price: 140 },
      { id: 'smugglers', name: 'Smugglers Notch', region: 'northern-vt', pass: 'ikon', vibe: 'sendit', rating: 4.2, price: 135 },

      { id: 'loon', name: 'Loon', region: 'white-mountains', pass: 'ikon', vibe: 'sendit', rating: 4.0, price: 130 },
      { id: 'waterville', name: 'Waterville Valley', region: 'white-mountains', pass: 'ikon', vibe: 'sendit', rating: 3.9, price: 120 },
      { id: 'cannon', name: 'Cannon', region: 'white-mountains', pass: 'ikon', vibe: 'sendit', rating: 3.8, price: 100 },
      { id: 'wildcat', name: 'Wildcat', region: 'white-mountains', pass: 'ikon', vibe: 'sendit', rating: 3.9, price: 110 },
      { id: 'bretton-woods', name: 'Bretton Woods', region: 'white-mountains', pass: 'ikon', vibe: 'sendit', rating: 4.0, price: 135 },
      { id: 'cranmore', name: 'Cranmore', region: 'white-mountains', pass: 'ikon', vibe: 'sendit', rating: 3.7, price: 105 },
      { id: 'gunstock', name: 'Gunstock', region: 'white-mountains', pass: 'ikon', vibe: 'sendit', rating: 3.6, price: 95 },
      { id: 'ragged', name: 'Ragged', region: 'white-mountains', pass: 'ikon', vibe: 'sendit', rating: 3.5, price: 90 },

      { id: 'sunday-river', name: 'Sunday River', region: 'maine', pass: 'ikon', vibe: 'sendit', rating: 4.1, price: 140 },
      { id: 'sugarloaf', name: 'Sugarloaf', region: 'maine', pass: 'ikon', vibe: 'sendit', rating: 4.3, price: 145 },
      { id: 'saddleback', name: 'Saddleback', region: 'maine', pass: 'ikon', vibe: 'sendit', rating: 3.9, price: 120 },
    ];

    resorts.forEach(r => {
      r.live = { weather: null, forecast: null, lifts: null };
    });

    const resortGrid = document.getElementById('resortGrid');
    const regionButtons = document.querySelectorAll('[data-region]');
    const passButtons = document.querySelectorAll('[data-pass]');
    const vibeButtons = document.querySelectorAll('[data-vibe]');
    const sortSelect = document.getElementById('sortSelect');
    const checkConditionsBtn = document.getElementById('checkConditionsBtn');

    let activeRegion = 'all';
    let activePass = 'all';
    let activeVibe = 'all';
    let activeSort = 'rating-high';

    function wireFilters() {
      regionButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          regionButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activeRegion = btn.dataset.region || 'all';
          renderResorts();
        });
      });

      passButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          passButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activePass = btn.dataset.pass || 'all';
          renderResorts();
        });
      });

      vibeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          vibeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activeVibe = btn.dataset.vibe || 'all';
          renderResorts();
        });
      });

      if (sortSelect) {
        sortSelect.addEventListener('change', () => {
          activeSort = sortSelect.value;
          renderResorts();
        });
      }

      if (checkConditionsBtn) {
        checkConditionsBtn.addEventListener('click', () => {
          window.scrollTo({ top: resortGrid.offsetTop - 60, behavior: 'smooth' });
        });
      }
    }

    function computeRating(resort) {
      const base = resort.rating || 3;
      let boost = 0;
      const live = resort.live || {};

      if (live.weather && typeof live.weather.temp === 'number') {
        if (live.weather.temp > 10 && live.weather.temp < 35) boost += 0.3;
      }

      if (live.forecast && Array.isArray(live.forecast)) {
        const snowToday = live.forecast[0]?.snow || '0"';
        const inches = parseInt(String(snowToday).replace(/[^0-9]/g, ''), 10) || 0;
        if (inches >= 4) boost += 0.5;
      }

      if (live.lifts) {
        const total = live.lifts.total || 0;
        const open = live.lifts.open || 0;
        if (total > 0) {
          const pct = open / total;
          if (pct > 0.6) boost += 0.3;
          else if (pct < 0.3) boost -= 0.3;
        }
      }

      let rating = base + boost;
      if (rating < 1) rating = 1;
      if (rating > 5) rating = 5;
      return Math.round(rating * 10) / 10;
    }

    function renderResorts() {
      if (!resortGrid) return;
      resortGrid.innerHTML = '';

      let filtered = resorts.slice();

      if (activeRegion !== 'all') {
        filtered = filtered.filter(r => r.region === activeRegion);
      }
      if (activePass !== 'all') {
        filtered = filtered.filter(r => r.pass === activePass);
      }
      if (activeVibe !== 'all') {
        filtered = filtered.filter(r => r.vibe === activeVibe);
      }

      filtered.forEach(r => {
        r._computedRating = computeRating(r);
      });

      filtered.sort((a, b) => {
        switch (activeSort) {
          case 'rating-low':
            return a._computedRating - b._computedRating;
          case 'snow-24h':
            return 0;
          case 'snow-7d':
            return 0;
          case 'price-low':
            return (a.price || 0) - (b.price || 0);
          case 'price-high':
            return (b.price || 0) - (a.price || 0);
          case 'rating-high':
          default:
            return b._computedRating - a._computedRating;
        }
      });

      for (const resort of filtered) {
        const live = resort.live || {};
        const card = document.createElement('div');
        card.className = 'resort-card';
        card.dataset.resort = resort.id;

        const weather = live.weather;
        const lifts = live.lifts;
        const forecast = live.forecast;
        const rating = resort._computedRating || resort.rating || 3;

        card.innerHTML = `
          <div class="resort-header">
            <div class="resort-location">${resort.name || resort.id}</div>
          </div>
          <div class="resort-body">
            <div class="rating-section">
              <div>
                <div class="rating-label">Overall Vibes</div>
                <div class="rating-stars">
                  ${[1,2,3,4,5].map(i =>
                    `<span class="star ${i <= Math.round(rating) ? 'filled' : 'empty'}">‚òÖ</span>`
                  ).join('')}
                </div>
              </div>
              <div class="rating-text">${rating.toFixed(1)}/5</div>
            </div>

            <div class="conditions-highlight">
              <div class="conditions-label">Current Conditions</div>
              <div class="conditions-value">
                ${
                  weather
                    ? `${weather.icon || '‚ùÑÔ∏è'} ${weather.temp}¬∞F ¬∑ ${weather.condition}`
                    : 'Using typical conditions'
                }
              </div>
            </div>

            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Wind</span>
                <span class="info-value">${weather && weather.wind ? weather.wind : '‚Äî'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Humidity</span>
                <span class="info-value">${weather && typeof weather.humidity === 'number' ? weather.humidity + '%' : '‚Äî'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Lifts</span>
                <span class="info-value">${lifts ? `${lifts.open}/${lifts.total} open` : '‚Äî'}</span>
              </div>
            </div>

            ${
              forecast && Array.isArray(forecast) && forecast.length
                ? `<details class="forecast-details">
                     <summary class="forecast-toggle">3-Day Forecast</summary>
                     <div class="forecast-grid">
                       ${forecast.map(day => `
                         <div class="forecast-day">
                           <div class="forecast-day-name">${day.day}</div>
                           <div class="forecast-icon">${day.icon}</div>
                           <div class="forecast-temp">${day.temp}¬∞F</div>
                           <div class="forecast-snow">${day.snow}</div>
                         </div>`).join('')}
                     </div>
                   </details>`
                : ''
            }

            ${
              lifts && lifts.details
                ? `<details class="lift-details">
                     <summary class="lift-toggle">
                       <div class="lift-toggle-left">
                         <span>Lifts</span>
                         <span class="lift-toggle-counts">${lifts.open}/${lifts.total} open</span>
                       </div>
                     </summary>
                     <div class="lift-list">
                       ${Object.entries(lifts.details).map(([name, status]) => `
                         <div class="lift-item">
                           <span class="lift-dot ${status}"></span>
                           <span class="lift-name ${status === 'open' ? '' : 'closed-lift'}">${name}</span>
                         </div>`).join('')}
                     </div>
                   </details>`
                : ''
            }
          </div>
        `;

        resortGrid.appendChild(card);
      }

      if (filtered.length === 0) {
        resortGrid.innerHTML = '<div class="loading">No resorts match your filters.</div>';
      }
    }

    async function loadLiveData() {
      try {
        const resp = await fetch(WORKER_URL, {
          method: 'GET',
          headers: { 'Cache-Control': 'no-cache' }
        });

        if (!resp.ok) {
          throw new Error(`Worker returned ${resp.status}`);
        }

        const result = await resp.json();

        if (result.error) {
          throw new Error(result.error || 'Worker returned error');
        }

        const apiData = result.data || {};
        const metadata = apiData._metadata || null;

        let updatedCount = 0;

        resorts.forEach(resort => {
          const live = apiData[getWorkerID(resort.id)];
          if (!live) return;

          if (live.weather) resort.live.weather = live.weather;
          if (live.forecast) resort.live.forecast = live.forecast;
          if (live.lifts) resort.live.lifts = live.lifts;

          updatedCount++;
        });

        if (updatedCount > 0) {
          showStatus(
            metadata && metadata.lastUpdated
              ? `Live data loaded ¬∑ Updated ${new Date(metadata.lastUpdated).toLocaleTimeString()}`
              : 'Live data loaded',
            'success'
          );
        } else {
          showStatus('Live data loaded but no matching resorts found', 'warning');
        }

        renderResorts();
      } catch (err) {
        console.error('Failed to load live data:', err);
        showStatus('APIs connecting ‚Äì using defaults for now', 'warning');
        renderResorts();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      wireFilters();
      loadLiveData();
    });
  </script>
</body>
</html>
